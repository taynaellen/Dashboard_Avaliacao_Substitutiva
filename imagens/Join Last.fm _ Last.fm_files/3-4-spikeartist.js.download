define(["jquery","core/ajax","kerve/helpers/windowscroll","kerve/helpers/windowsize","kerve/helpers/helper"],function(m,i,t,s,c){function e(e,t){this.el=e}e.prototype.start=function(){k.logs=1==c.config.logs||1==k.dev,k.logs&&console.log("%c*** WIDGET - 3.4 SPIKE ARTIST - START ***","color:#098c0c;"),k.el=this.el,k.query_user=k.el.attr("data-user")||"",k.locale=k.el.attr("data-locale")||"",k.locale_plays=k.el.attr("data-locale-plays")||"",k.locale_play=k.el.attr("data-locale-play")||"",k.locale_title1=k.el.attr("data-locale-title1")||"",k.locale_title2=k.el.attr("data-locale-title2")||"",k.locale_subtitle=k.el.attr("data-locale-subtitle")||"",k.spikewrap=k.el.find(".spikewrap"),k.spikeartist=k.el.find(".spikeartist"),k.spike_title=k.el.find(".widget_title"),k.spike_intro=k.el.find(".spike_intro"),k.spike_intro2=k.el.find(".spike_intro_copy2"),k.spike_name=k.el.find(".spike_name"),k.spike_back=k.el.find(".spike_back"),k.spike_reset=k.el.find(".spike_reset"),k.spike_result=k.el.find(".spike_result"),k.spike_scrobbles=k.el.find(".spike_scrobbles"),k.label_scroll=k.el.find(".label_scroll"),k.label_span=k.el.find(".label_span"),k.el.on("click",".bubble",function(){return 0==k.animating&&(k.animating=!0,k.query=m(this).attr("data-val"),l(k.query,!0),m(this).siblings().remove(),m(this).removeClass("done").addClass("spikeartist animated"),k.spikeartist=k.el.find(".spikeartist"),k.spike_title.html(k.locale_title2),k.spike_intro2.html(k.locale_subtitle.replace("XXX","<strong>"+k.query+"</strong>")),k.spike_intro.addClass("spikehide"),k.spike_name.hide(),k.spike_back.hide(),k.spike_reset.hide(),k.timeout_create=setTimeout(function(){y(k.query)},500)),!1}),k.spike_back.click(function(){0==k.animating&&1<b.length&&(k.animating=!0,b.pop(),k.query=b[b.length-1],b.length<=1?(k.spike_title.html(k.locale_title1),k.spike_intro.removeClass("spikehide")):(k.spike_title.html(k.locale_title2),k.spike_intro2.html(k.locale_subtitle.replace("XXX","<strong>"+k.query+"</strong>"))),k.spike_name.hide(),k.spike_back.hide(),k.spike_reset.hide(),y(k.query))}),k.spike_reset.click(function(){0==k.animating&&1<b.length&&(k.animating=!0,b=[""],k.query=b[b.length-1],k.spike_title.html(k.locale_title1),k.spike_intro.removeClass("spikehide"),k.spike_name.hide(),k.spike_back.hide(),k.spike_reset.hide(),y(k.query))}),a(),l(k.query,!0);var e=k.spikewrap.offset().top+k.spikewrap.height()/2;t.add("spike",e,function(){k.timeout_init=setTimeout(function(){y(k.query)},1e3)}),s.add("spike",{x_func:function(){var e;a(),k.width!=k.width_old&&y(k.query),0==t.done("spike")&&(e=k.spikewrap.offset().top+k.spikewrap.height()/2,t.update_pos("spike",e)),c.label_scroll(k.label_scroll,k.label_span)}})};var k={dev:!(e.prototype.stop=function(){k.logs&&console.log("%c*** WIDGET - 3.4 SPIKE ARTIST - STOP ***","color:#098c0c;"),clearTimeout(k.timeout_init),clearTimeout(k.timeout_bubbles),clearTimeout(k.timeout_create),clearTimeout(k.timeout_details),clearTimeout(k.timeout_details2),clearTimeout(k.timeout_show1),clearTimeout(k.timeout_show2),b=[],h={},g={},f="",t.reset(),s.reset()}),dev_data:!1,query_url:"https://kerve.last.fm/kerve/charts",query_url2:"https://kerve.last.fm/kerve/similarartists",query_limit:30,backup_img:"/static/images/kerve/profile.jpg",dims:{1:{min_d:50,max_d:100},2:{min_d:40,max_d:90},3:{min_d:40,max_d:90},4:{min_d:35,max_d:80},5:{min_d:35,max_d:70},6:{min_d:35,max_d:70},7:{min_d:35,max_d:70}},bubble_spacing:15,retries:1800,size:1,width_old:0,width:0,height:0,spike_d:262,spike_r:131,spike_x:454,spike_y:10,animating:!0,got_data:!1,query:"",xmin:0,xmax:0,step:0,loop:0,timeout_init:null,timeout_bubbles:null,timeout_create:null,timeout_details:null,timeout_details2:null,timeout_show1:null,timeout_show2:null},b=[],h={},g={},f="",v=(Math.PI,Math.PI/180);function a(){k.width_old=k.width,k.width=k.spikewrap.width(),k.height=k.spikewrap.height(),k.spike_d=k.spikeartist.width(),k.spike_r=k.spike_d/2,k.spike_x=k.spikeartist.position().left-k.spike_r,k.spike_y=k.spikeartist.position().top,1170==k.width?k.size=1:940==k.width?k.size=2:670<=k.width?k.size=3:570<=k.width?k.size=4:470<=k.width?k.size=5:370<=k.width?k.size=6:k.size=7}function l(l,r){if(k.got_data=!1,b.push(l),void 0!==h[l])k.got_data=!0,1!=r&&y(l);else if(f="",h[l]={},1==k.dev_data||1==c.config.dev){var e,t=c.dev["3-4a-spikeartist"].results.artist;for(e in t)t[e].val=t.length-e,h[l][e]=t[e];k.got_data=!0,1!=r&&y(l)}else""==l?i.get(k.query_url,null,{type:"artist",tracks:1,nr:30,format:"json"},function(e,t,i,s){if(k.logs&&console.log("--- ajax response - 3.4 spike artists - 1 trending ---"),k.logs&&console.log(t.results.artist),void 0!==t.results.artist){for(var a in t.results.artist)t.results.artist[a].val=t.results.artist.length-a,h[l][a]=t.results.artist[a];k.got_data=!0,1!=r&&y(l)}}):i.get(k.query_url2,null,{artist:c.query_format(l),autocorrect:1,tracks:1,image_size:"large",limit:30,format:"json"},function(e,t,i,s){if(k.logs&&console.log("--- ajax response - 3.4 spike artists - 2 similar ---"),k.logs&&console.log(t.results.artist),void 0!==t.results&&void 0!==t.results.artist){for(var a in t.results.artist)t.results.artist[a].val=t.results.artist.length-a,h[l][a]=t.results.artist[a];k.got_data=!0,1!=r&&y(l)}void 0!==t.results&&void 0!==t.results.main_artist&&(f=t.results.main_artist)})}function y(e){if(1==k.got_data){for(var t in k.xmax=0,k.xmin=0,g={},h[e])h[e][t].val>k.xmax&&(k.xmax=h[e][t].val),(h[e][t].val<k.xmin||0==k.xmin)&&(k.xmin=h[e][t].val);if(k.step=(k.dims[k.size].max_d-k.dims[k.size].min_d)/(k.xmax-k.xmin),""==e)i=(i='<div class="bubble spikeartist" data-val="'+h[e][0].name+'" >')+('<div class="bubble_img" style="background-image:url('+(void 0!==h[e][0].image&&""!=h[e][0].image?h[e][0].image:k.backup_img)+');"></div>')+"</div>";else{var i,s=h[b[b.length-2]];for(t in s)e==s[t].name&&(data_current2=s[t]);i=(i='<div class="bubble spikeartist" data-val="'+data_current2.name+'" >')+('<div class="bubble_img" style="background-image:url('+(void 0!==data_current2.image&&""!=data_current2.image?data_current2.image:k.backup_img)+');"></div>')+"</div>"}var a,l=0;for(t in h[e])(""!=e||""==e&&0<t)&&(k.loop=0)!=(a=function e(t){var i={y:k.spike_y+k.spike_r,x:k.spike_x+k.spike_r,r:k.spike_r+k.bubble_spacing+Math.random()*(k.loop/5)};var s=360*Math.random()*v;var a={};a.d=Math.round(k.dims[k.size].min_d+(t.val-k.xmin)*k.step);a.r=a.d/2;a.x=i.x+(i.r+a.r)*Math.cos(s)-a.r;a.y=i.y+(i.r+a.r)*Math.sin(s)-a.r;(1==x(a)||1==w(a))&&k.loop<k.retries&&(k.loop++,a=e(t));return!(k.loop>=k.retries)&&a}(h[e][t]))&&(l++,m.extend(h[e][t],a),g[t]=a,30<(r=h[e][t].name).length&&(r=r.substr(0,29)+"â€¦"),i=(i=(i=(i+='<div class="bubble" id="bubble'+l+'" data-val="'+h[e][t].name+'" style="width:'+h[e][t].d+"px;height:"+h[e][t].d+"px;top:"+h[e][t].y+"px;left:"+h[e][t].x+'px;">')+'<div class="bubble_img" style="background-image:url('+(void 0!==h[e][t].image&&""!=h[e][t].image?h[e][t].image:k.backup_img)+');"></div>')+'<div class="bubble_number">'+(parseInt(l)+1)+"</div>")+'<div class="bubble_name">'+r+"</div></div>");k.spikewrap.html(i),k.spikeartist=k.el.find(".spikeartist");var r,o,n,d,u,_,p=30;for(t=0;t<=l;t++)!function(s,e){k.timeout_show1=setTimeout(function(){var e=k.el.find(".spikewrap #bubble"+s),t=e.find(".bubble_name"),i=(e.addClass("show"),t.outerWidth());t.css({"margin-left":-i/2}),k.timeout_show2=setTimeout(function(){e.addClass("done")},800)},e)}(t,p+=30);""==e?void 0!==h[e][0].url&&""!=h[e][0].url?k.spike_name.html('<a href="'+c.url(h[e][0].url,k.locale)+'">'+h[e][0].name+"</a>"):k.spike_name.html(h[e][0].name):void 0!==data_current2.url&&""!=data_current2.url?k.spike_name.html('<a href="'+c.url(data_current2.url,k.locale)+'">'+data_current2.name+"</a>"):k.spike_name.html(data_current2.name),k.timeout_details=setTimeout(function(){k.spike_name.fadeIn(),1<b.length&&(k.spike_back.fadeIn().css({display:"inline-block"}),k.spike_reset.fadeIn().css({display:"inline-block"}))},.75*p),k.timeout_details2=setTimeout(function(){k.animating=!1},p+400),"undefined"!==(void 0!==h[e][0]&&typeof h[e][0].tracks)||""!=f?(_=(""!=f?(r=f.artist,o=f.url,n=f.top_track.name,d=f.top_track.url,u=f.top_track.scrobbles,f.top_track):(r=h[e][0].name,o=h[e][0].url,n=h[e][0].tracks[0].name,d=h[e][0].tracks[0].url,u=h[e][0].scrobbles,h[e][0].tracks[0])).playlink,k.spike_result.html(c.track(r,o,n,d,k.locale)+c.play(k.locale_play,_)),k.spike_scrobbles.text(k.locale_plays+": "+c.commas(u))):(k.spike_result.html(""),k.spike_scrobbles.text("")),c.label_scroll(k.label_scroll,k.label_span)}else k.timeout_bubbles=setTimeout(function(){y(e)},50)}function x(e){var t=!1,i=k.width,s=k.height;return t=e.x<0||e.y<0||e.x+e.d>i||e.y+e.d>s?!0:t}function w(e){var t,i=e.d/2,s=e.x+e.d/2,a=e.y+e.d/2,l=!1;for(t in g){var r=g[t].d/2,o=g[t].x+g[t].d/2,n=g[t].y+g[t].d/2,r=i+r+k.bubble_spacing,o=s-o,n=a-n;Math.sqrt(o*o+n*n)<r&&(l=!0)}return l}return e});