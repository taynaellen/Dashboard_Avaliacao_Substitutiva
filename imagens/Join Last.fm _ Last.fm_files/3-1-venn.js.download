define(["jquery","core/ajax","kerve/helpers/windowscroll","kerve/helpers/windowsize","kerve/helpers/helper"],function(i,a,t,n,l){function e(e,t){this.el=e}e.prototype.start=function(){r.logs=1==l.config.logs||1==r.dev,r.logs&&console.log("%c*** WIDGET - 3.1 VENN - START ***","color:#098c0c;"),r.logs=1==l.config.logs||1==r.dev,r.el=this.el,r.locale=r.el.attr("data-locale")||"",r.locale_plays=r.el.attr("data-locale-plays")||"",r.locale_play=r.el.attr("data-locale-play")||"",r.locale_error=r.el.attr("data-locale-error")||"",r.locale_titles=r.el.attr("data-locale-titles")||"",r.wrap=r.el.find(".vennwrap"),r.venn=r.el.find(".venn"),r.title=r.el.find(".venn_title"),r.image=r.el.find(".venn_img"),r.label=r.el.find(".label_result"),r.label_scroll=r.el.find(".label_scroll"),r.label_span=r.el.find(".label_span"),r.result=r.el.find(".venn_result"),r.scrobbles=r.el.find(".venn_scrobbles"),r.venn1=r.el.find(".venn1"),r.venn2=r.el.find(".venn2"),r.vennrotate1=r.el.find(".venn1 .venn_rotate"),r.vennrotate2=r.el.find(".venn2 .venn_rotate"),r.vennname1=r.el.find(".vennname1"),r.vennname2=r.el.find(".vennname2"),r.handlewrap=r.el.find(".venn .handlewrap"),r.handlehover=r.el.find(".venn .handle_hover"),function e(t){{var n,a,o;"string"==typeof r.locale_titles&&""!=i.trim(r.locale_titles)&&(a=r.locale_titles.split(","),1<(o=a.length))&&(n=!0,o=Math.floor(Math.random()*o),""!=(a=i.trim(a[o]))&&0<(o=a.split(" - ")).length&&(a=o[0].replace(/venn/g,'<span class="red">venn</span>').replace(/Venn/g,'<span class="red">Venn</span>').replace(/VENN/g,'<span class="red">VENN</span>'),o=1<o.length?'<a href="'+l.url(o[1],r.locale)+'">'+a+"</a>":a,n=!1,r.title.html(o)),1==n)&&t<5&&e(++t)}r.title.show()}(0),r.venn.on("mousedown",f),i("body").on("mousemove",_),i("body").on("mouseup",p),window.navigator.msPointerEnabled||window.navigator.pointerEnabled?(r.venn.on(window.navigator.msPointerEnabled?"MSPointerDown":"pointerdown",f),i("body").on(window.navigator.msPointerEnabled?"MSPointerMove":"pointermove",_),i("body").on(window.navigator.msPointerEnabled?"MSPointerUp":"pointerup",p)):(r.venn.on("touchstart",f),i("body").on("touchmove",_),i("body").on("touchend",p)),r.handlewrap.on("mouseover",function(){i(this).children(".handle_hover").addClass("visible")}),r.handlewrap.on("mouseout",function(){r.handlehover.removeClass("visible")}),d(),r.v1.init=Math.round(20+60*Math.random()),r.v2.init=Math.round(20+60*Math.random()),r.v1.tag=m(r.v1.init,1),r.v2.tag=m(r.v2.init,2),1==r.dev_data||1==l.config.dev?(s[r.v1.tag+"+"+r.v2.tag]=l.dev["3-1-venn"].results.track[0],r.got_init=!0):a.get(r.query_url,{traditional:!0},{nr:"1",type:"track",f:["tag:"+l.query_format(r.v1.tag),"tag:"+l.query_format(r.v2.tag)],format:"json"},function(e,t,n,a){r.logs&&console.log("--- ajax response - 3.1 venn - 1 ---"),r.logs&&console.log(t.results.track),void 0!==t.results&&void 0!==t.results.track&&0<t.results.track.length&&(s[r.v1.tag+"+"+r.v2.tag]=t.results.track[0],""!=t.results.track[0].image)&&((img=new Image).src=t.results.track[0].image),r.got_init=!0});var e=r.wrap.offset().top+r.wrap.height()/2;t.add("venn",e,function(){!function e(){1==r.got_init?r.timeout_init1=setTimeout(function(){v(r.v1.init,1),r.timeout_init2=setTimeout(function(){v(r.v2.init,2)},400),r.timeout_init3=setTimeout(function(){r.animating=!1},1e3)},1e3):r.timeout_init1=setTimeout(function(){e()},50)}()}),n.add("venn",{x_func:function(){var e;0==t.done("venn")&&(e=r.wrap.offset().top+r.wrap.height()/2,t.update_pos("venn",e)),d(),l.label_scroll(r.label_scroll,r.label_span)}})};var r={dev:!(e.prototype.stop=function(){r.logs&&console.log("%c*** WIDGET - 3.1 VENN - STOP ***","color:#098c0c;"),clearTimeout(r.timeout_results),clearTimeout(r.timeout_init1),clearTimeout(r.timeout_init2),clearTimeout(r.timeout_init3),clearTimeout(r.timeout_class),s={},i("body").off("mousemove",_),i("body").off("mouseup",p),window.navigator.msPointerEnabled||window.navigator.pointerEnabled?(i("body").off(window.navigator.msPointerEnabled?"MSPointerMove":"pointermove",_),i("body").off(window.navigator.msPointerEnabled?"MSPointerUp":"pointerup",p)):(i("body").off("touchmove",_),i("body").off("touchend",p)),i("body").removeClass("noselect"),t.reset(),n.reset()}),dev_data:!1,cache_data:!1,query_url:"https://kerve.last.fm/kerve/charts",results_timeout:300,default_img:"/static/images/kerve/venn_default.jpg",tag1:["1920s","1930s","1940s","1950s","1960s","1970s","1980s","1990s","2000s","2010s"],tag2:["Rock","Electronic","Indie","Pop","Metal","Hip Hop","Punk","Dance","Chillout","Experimental"],animating:!0,id:"v1",id2:1,got_init:!1,origin:{x:0,y:0},v1:{moving:!1,current:0,a_min:208,a_max:332,step:0,temp:0,a1:0,a2:0,tag:"",init:null},v2:{moving:!1,current:0,a_min:28,a_max:152,step:0,temp:0,a1:0,a2:0,tag:"",init:null},timeout_init1:null,timeout_init2:null,timeout_init3:null,timeout_class:null,timeout_results:null},s={},o=180/Math.PI;Math.PI;function d(){r.origin={x:parseInt(r["venn"+r.id2].width())/2,y:parseInt(r["venn"+r.id2].height())/2}}function v(e,t){e=function(e,t){void 0===t&&(t=r.id2);e=(r["v"+t].a_max-r["v"+t].a_min)*(e/100)+r["v"+t].a_min;return Math.round(e)}(e,t);u(r["v"+t].current=e,t,!0)}function u(e,t,n){void 0===t&&(t=r.id2),1==n?(n=1==t&&e<90?e+360:e,r["vennrotate"+t].addClass("animate").css({"-webkit-transform":"rotate("+n+"deg)","-moz-transform":"rotate("+n+"deg)","-ms-transform":"rotate("+n+"deg)",transform:"rotate("+n+"deg)"}),r.timeout_class=setTimeout(function(){r["vennrotate"+t].removeClass("animate")},1e3)):r["vennrotate"+t].css({"-webkit-transform":"rotate("+e+"deg)","-moz-transform":"rotate("+e+"deg)","-ms-transform":"rotate("+e+"deg)",transform:"rotate("+e+"deg)"}),r["v"+t].tag=m(function(e,t){void 0===t&&(t=r.id2);e=(e-r["v"+t].a_min)/(r["v"+t].a_max-r["v"+t].a_min)*100;return Math.round(e)}(e,t),t),r["vennname"+t].text(r["v"+t].tag),clearTimeout(r.timeout_results),r.timeout_results=setTimeout(function(){var e,o=r.v1.tag,i=r.v2.tag;0==r.cache_data||void 0===s[o+"+"+i]?1==r.dev_data||1==l.config.dev?(e=Math.floor(6*Math.random())+1,s[o+"+"+i]=l.dev["3-1-venn"].results.track[e],g(o,i)):(0==r.cache_data&&void 0!==s[o+"+"+i]&&(delete s[o+"+"+i],r.image.css({"background-image":"none"})),a.get(r.query_url,{traditional:!0},{nr:"1",type:"track",f:["tag:"+l.query_format(o),"tag:"+l.query_format(i)],format:"json"},function(e,t,n,a){r.logs&&console.log("--- ajax response - 3.1 venn - 2 ---"),r.logs&&console.log(t),void 0!==t.results&&void 0!==t.results.track&&0<t.results.track.length?(s[o+"+"+i]=t.results.track[0],g(o,i)):(r.image.css({"background-image":"url("+r.default_img+")"}),r.label.addClass("noresults"),r.result.html(r.locale_error),r.scrobbles.text(""),l.label_scroll(r.label_scroll,r.label_span))})):g(o,i)},r.results_timeout)}function c(e){var e={x:r.origin.x-e.x,y:-(r.origin.y-e.y)},t=(0==e.y&&(e.y=.1),Math.atan(e.y/e.x)*o);return t<0&&(t=180+t),t=(t=270-(t=e.y<0?180+t:t))<0?360+t:t}function m(e,t){e=Math.floor(e/10);return r["tag"+t][e=9<e?9:e]}function g(e,t){""!=s[e+"+"+t].image?r.image.css({"background-image":"url("+s[e+"+"+t].image+")"}):r.image.css({"background-image":"url("+r.default_img+")"}),r.label.removeClass("noresults"),r.result.html(l.track(s[e+"+"+t].artist,s[e+"+"+t].artist_url,s[e+"+"+t].name,s[e+"+"+t].url,r.locale)+l.play(r.locale_play,s[e+"+"+t].playlink)),r.scrobbles.text(r.locale_plays+": "+l.commas(s[e+"+"+t].scrobbles)),l.label_scroll(r.label_scroll,r.label_span)}function f(e){0==r.animating&&(l.pauseEvent(e),i("body").addClass("noselect"),r.id=i(this).attr("data-id"),r.id2=r.id.replace("v",""),e={x:l.eventx(e)-r["venn"+r.id2].offset().left,y:l.eventy(e)-r["venn"+r.id2].offset().top},r[r.id].a1=c(e),r[r.id].moving=!0,r.el.find(".venn"+r.id2+" .handle_hover").addClass("visible2"))}function _(e){1==r[r.id].moving&&(l.pauseEvent(e),e={x:l.eventx(e)-r["venn"+r.id2].offset().left,y:l.eventy(e)-r["venn"+r.id2].offset().top},r[r.id].a2=c(e),h())}function p(e){1==r[r.id].moving&&(l.pauseEvent(e),i("body").removeClass("noselect"),r[r.id].moving=!1,h(!0),r.handlehover.removeClass("visible2"))}function h(e){var t=r[r.id].a2-r[r.id].a1,t=r[r.id].current+t;t<0?t+=360:360<t&&(t-=360),"v1"==r.id?t>r.v1.a_max||t<90?t=r.v1.a_max:t<r.v1.a_min&&(t=r.v1.a_min):"v2"==r.id&&(270<t||t<r.v2.a_min?t=r.v2.a_min:t>r.v2.a_max&&(t=r.v2.a_max)),r[r.id].temp=t,1==e&&(r[r.id].current=r[r.id].temp),u(Math.round(r[r.id].temp))}return e});