define(["jquery","core/ajax","kerve/helpers/windowscroll","kerve/helpers/windowsize","kerve/helpers/helper","kerve/widgets/3-7-world_data"],function(l,s,c,u,d,f){function t(t,e){this.el=t}t.prototype.start=function(){p.logs=1==d.config.logs||1==p.dev,p.logs&&console.log("%c*** WIDGET - 3.7 AROUND THE WORLD - START ***","color:#098c0c;"),p.el=this.el,p.locale=p.el.attr("data-locale")||"",p.locale_plays=p.el.attr("data-locale-plays")||"",p.locale_play=p.el.attr("data-locale-play")||"",p.locale_none=p.el.attr("data-locale-none")||"",p.locale_error=p.el.attr("data-locale-error")||"",p.has_transform=d.has_transform(),p.wrap3=p.el.find(".worldwrap3"),p.bg=p.el.find(".world_bg"),p.country=p.el.find(".country"),p.handle=p.el.find(".world_handle"),p.axis_x=p.el.find(".world_x"),p.axis_y=p.el.find(".world_y"),p.label_scroll=p.el.find(".label_scroll"),p.label_span=p.el.find(".label_span"),p.result=p.el.find(".world_result"),p.scrobbles=p.el.find(".world_scrobbles"),p.el.on("mouseenter",".worldwrap2",function(){p.paused=!0}),p.el.on("mouseleave",".worldwrap2",function(){p.paused=!1}),p.wrap3.on("click",y),p.handle.on("mousedown",m),l("body").on("mousemove",w),l("body").on("mouseup",v),window.navigator.msPointerEnabled||window.navigator.pointerEnabled?(p.handle.on(window.navigator.msPointerEnabled?"MSPointerDown":"pointerdown",m),l("body").on(window.navigator.msPointerEnabled?"MSPointerMove":"pointermove",w),l("body").on(window.navigator.msPointerEnabled?"MSPointerUp":"pointerup",v)):(p.handle.on("touchstart",m),l("body").on("touchmove",w),l("body").on("touchend",v)),p.width=p.wrap3.width(),p.height=p.wrap3.height(),p.country_total=d.objectLength(f);var t,e="";for(t in f)for(var o in f[t])e+='<div class="country country_'+t+'" data-country="'+t+'" style="top:'+f[t][o].top+"%;left:"+f[t][o].left+"%;width:"+f[t][o].width+"%;height:"+f[t][o].height+'%;"></div>';p.bg.html(e),p.country=p.el.find(".country");var a=p.el.attr("data-country"),n=(void 0===a&&(a=p.country_default),void 0===f[a]&&(a=p.country_default),p.init2.x=b(a),p.init2.y=x(a),1==p.dev_data||1==d.config.dev?(n=d.dev["3-7-world"],g[a]=n.results.track[0],p.got_init=!0):s.get(p.query_url,null,{type:"track",f:"geo:"+a,geo:300,users:0,tags:0,nr:1,format:"json"},function(t,e,o,n){p.logs&&console.log("--- ajax response - 3.7 around the world - 1 - "+a+" ---"),p.logs&&console.log(e.results.track),void 0!==e.results.track[0]&&(g[a]=e.results.track[0],p.got_init=!0)}),p.wrap3.offset().top),r=n+p.wrap3.height()/2,i=n+p.wrap3.height();c.add("world",r,function(){!function t(){1==p.got_init?1==p.intro?(p.current={x:T(p.init2.x),y:P(p.init2.y)},p.currentp={x:p.init2.x,y:p.init2.y},h()):(p.current={x:T(8),y:P(16)},p.currentp={x:8,y:16},p.animating=!1):p.timeout_init=setTimeout(function(){t()},50)}()},n,i,function(){p.paused=!0},function(){p.paused=!1}),u.add("world",{x_func:function(){var t,e,o;0==c.done("world")&&(e=(t=p.wrap3.offset().top)+p.wrap3.height()/2,o=t+p.wrap3.height(),c.update_pos("world",e,t,o)),p.width=p.wrap3.width(),p.height=p.wrap3.height(),p.current={x:T(p.currentp.x),y:P(p.currentp.y)},_(),d.label_scroll(p.label_scroll,p.label_span)}})};var p={dev:!(t.prototype.stop=function(){p.logs&&console.log("%c*** WIDGET - 3.7 AROUND THE WORLD - STOP ***","color:#098c0c;"),clearTimeout(p.timeout_init),clearTimeout(p.timeout_init2),clearTimeout(p.timeout_blockclick),clearInterval(p.int_animate),g={},l("body").off("mousemove",w),l("body").off("mouseup",v),window.navigator.msPointerEnabled||window.navigator.pointerEnabled?(l("body").off(window.navigator.msPointerEnabled?"MSPointerMove":"pointermove",w),l("body").off(window.navigator.msPointerEnabled?"MSPointerUp":"pointerup",v)):(l("body").off("touchmove",w),l("body").off("touchend",v)),l("body").removeClass("noselect"),c.reset(),u.reset()}),dev_data:!1,intro:!0,query_url:"https://kerve.last.fm/kerve/charts",country_default:"gb",t_autoplay:3e3,init:{x:92,y:84},init2:{x:44,y:19},heat_grads:10,width:0,height:0,got_init:!1,has_transform:!1,paused:!1,country_total:0,animating:!0,moving:!1,blockclick:!1,current:{x:0,y:0},currentp:{x:0,y:0},start:{x:0,y:0},temp:{x:0,y:0},timeout_init:null,timeout_init2:null,timeout_blockclick:null,int_animate:null},g={};function h(){p.timeout_init=setTimeout(function(){p.handle.animate({left:p.init.x+"%",top:p.init.y+"%"},1e3).animate({left:p.init2.x+"%",top:p.init2.y+"%"},1e3),p.axis_x.animate({top:p.init.y+"%"},1e3).animate({top:p.init2.y+"%"},1e3),p.axis_y.animate({left:p.init.x+"%"},1e3).animate({left:p.init2.x+"%"},1e3)},1e3),p.timeout_init2=setTimeout(function(){_(),p.animating=!1,n()},4e3)}function a(t,e,o){0==p.animating&&(p.animating=!0,void 0===e&&(e=b(t)),void 0===o&&(o=x(t)),p.handle.animate({left:e+"%",top:o+"%"},1e3),p.axis_x.animate({top:o+"%"},1e3),p.axis_y.animate({left:e+"%"},1e3),p.currentp={x:e,y:o},p.current={x:T(e),y:P(o)},_(),p.timeout_init2=setTimeout(function(){p.animating=!1},1e3))}function n(){clearInterval(p.int_animate),p.int_animate=setInterval(function(){if(0==p.paused){var t,e=Math.floor(Math.random()*p.country_total-1),o=0,n=null;for(t in f)++o==e&&(n=t);null!=n&&a(n)}},p.t_autoplay)}function y(t){var e,o;0==p.animating&&0==p.blockclick&&(n(),null!=(o=i(e=k(d.eventx(t)-p.wrap3.offset().left),t=E(d.eventy(t)-p.wrap3.offset().top))))&&""!=o&&a(o,e,t)}function m(t){0==p.animating&&(d.pauseEvent(t),n(),l("body").addClass("noselect"),p.moving=!0,p.blockclick=!0,p.start={x:d.eventx(t)-p.wrap3.offset().left,y:d.eventy(t)-p.wrap3.offset().top})}function w(t){1==p.moving&&(d.pauseEvent(t),n(),p.temp={x:d.eventx(t)-p.wrap3.offset().left,y:d.eventy(t)-p.wrap3.offset().top},e())}function v(t){1==p.moving&&(d.pauseEvent(t),n(),l("body").removeClass("noselect"),p.moving=!1,e(!0),p.timeout_blockclick=setTimeout(function(){p.blockclick=!1},300))}function e(t){var e=p.current.x+(p.temp.x-p.start.x),o=p.current.y+(p.temp.y-p.start.y);e<0?e=0:e>p.width&&(e=p.width),o<0?o=0:o>p.height&&(o=p.height),p.handle.css({left:k(e)+"%",top:E(o)+"%"}),p.axis_x.css({top:E(o)+"%"}),p.axis_y.css({left:k(e)+"%"}),1==t&&(p.current={x:e,y:o},p.currentp={x:k(e),y:E(o)}),1==t&&_()}function _(){p.country.css({background:"none"});var t=i(p.currentp.x,p.currentp.y),a=(p.result.text(""),p.scrobbles.text(""),t);""==a?p.result.html(p.locale_none):void 0!==g[a]?r(a):1==p.dev_data||1==d.config.dev?(t=d.dev["3-7-world"],g[a]=t.results.track[0],r(a)):s.get(p.query_url,null,{geo:300,users:0,tags:0,nr:1,type:"track",f:"geo:"+a,format:"json"},function(t,e,o,n){p.logs&&console.log("--- ajax response - 3.7 around the world - 2 - "+a+" ---"),p.logs&&console.log(e),void 0!==e.results.track[0]?(g[a]=e.results.track[0],r(a)):p.result.html('<span class="label_genre">'+a+"</span> "+p.locale_error)})}function r(t){p.result.html('<span class="label_genre">'+t+"</span> "+d.track(g[t].artist,g[t].artist_url,g[t].name,g[t].url,p.locale)+d.play(p.locale_play,g[t].playlink)),p.scrobbles.text(p.locale_plays+": "+d.commas(g[t].scrobbles)),d.label_scroll(p.label_scroll,p.label_span,!0);var e=0,o=0;if(void 0!==g[t].geo){var n=g[t].geo;for(a in n)(0==e||n[a].weight<e)&&(e=n[a].weight),(0==o||n[a].weight>o)&&(o=n[a].weight);var a,r=o-e,i=r/(n.length>p.heat_grads?p.heat_grads:n.length);for(a in n){var l=(n[a].weight-e+i)/(r+i);p.el.find(".country_"+n[a].name.toLowerCase()).css({background:"rgba(193,25,25,"+l+")"})}}}function i(t,e){var o,n="";for(o in f)for(var a in f[o])t>f[o][a].left&&t<f[o][a].left+f[o][a].width&&e>f[o][a].top&&e<f[o][a].top+f[o][a].height&&(n=o);return n}function b(t){var e,o=0,n=0;for(e in f[t]){var a=f[t][e].left,r=f[t][e].left+f[t][e].width;(0==o||a<o)&&(o=a),(0==n||n<r)&&(n=r)}return o+(n-o)/2}function x(t){var e,o=0,n=0;for(e in f[t]){var a=f[t][e].top,r=f[t][e].top+f[t][e].height;(0==o||a<o)&&(o=a),(0==n||n<r)&&(n=r)}return o+(n-o)/2}function k(t){return t/p.width*100}function E(t){return t/p.height*100}function T(t){return t*p.width/100}function P(t){return t*p.height/100}return t});