define(["require","core/ajax","jquery"],function(t){"use strict";function e(t,e){this.$el=t,this.app=e,this.tour=!1,this.$body=i(this.app.body),this.tourName=!1,this.dynamicSteps=!1}var o=t("core/ajax"),i=t("jquery");return e.prototype.start=function(){this.init()},e.prototype.init=function(){if(this.dynamicSteps=this.findSteps(),this.stop(),this.dynamicSteps.length){this.partialRefreshBefore=this.app.eventMediator.subscribe("partialRefresh.beforeReplace",this.stop.bind(this)),this.AdRenderSucceeded=this.app.eventMediator.subscribe("AdRenderSucceeded",this.update.bind(this));const e=this;t(["shepherd"],function(t){e.tour=new t.Tour({defaultStepOptions:{classes:"",scrollTo:{behavior:"smooth",block:"center"},popperOptions:{modifiers:[{name:"offset",options:{offset:[-15,15]}},{name:"applyStyles"},{name:"arrow",options:{padding:15}}]},classPrefix:"my-tour-"}}),e.addSteps(e.processSteps(e.dynamicSteps)),e.tour.on("start",e.addEventListeners.bind(e)),e.tour.start()})}},e.prototype.addEventListeners=function(){this.tour.on("cancel",function(){this.app.eventMediator.publish("onboarding.tourguide.dismiss",this.tourName+"|"+this.tour.getCurrentStep().options.title),this.dismissTour(),this.cleanUpTour()}.bind(this)),this.tour.on("complete",function(){this.app.eventMediator.publish("onboarding.tourguide.complete",this.tourName),this.dismissTour(),this.cleanUpTour()}.bind(this))},e.prototype.update=function(){var t=this.tour.getCurrentStep();t&&t.tooltip.forceUpdate()},e.prototype.addSteps=function(t){this.tour.addSteps(t)},e.prototype.stop=function(){this.app.eventMediator.unsubscribe(this.partialRefreshBefore),this.app.eventMediator.unsubscribe(this.AdRenderSucceeded),this.tour&&(this.tour.cancel(),this.cleanUpTour())},e.prototype.processSteps=function(t){let i=this.tour;return t.forEach(function(t,s,r){r[s].buttons.forEach(function(t,e,o){s+1===r.length?o[e].action=i.complete:t.secondary?o[e].action=i.cancel:o[e].action=i.next})}),t},e.prototype.findSteps=function(){let t=this.$el.find("[data-tour-step]"),o=(t.length||(t=i("body").find("[data-tour-step]")),Array());if(t.length){o=Array(t.length);const s=t.toArray(),r=this;return s.forEach(function(t){var e;r.tourName=t.dataset.tourName,Number(t.dataset.tourStep)<=s.length&&(e={title:t.dataset.tourTitle,text:t.dataset.tourText,attachTo:{element:"[data-tour-step='"+t.dataset.tourStep+"']",on:"auto-start"},buttons:[{text:t.dataset.tourButtonPrimary}],when:{show(){var t=this.tour.currentStep.el,e=t.querySelector(".shepherd-content");const r=document.createElement("ul");r.classList.add("tourguide-step-list"),this.tour.steps.forEach((t,e,o)=>{var s=document.createElement("li");s.classList.add("tourguide-step"),e<=o.indexOf(this.tour.currentStep)&&s.classList.add("tourguide-step--viewed"),r.appendChild(s)}),e.insertBefore(r,t.querySelector(".shepherd-header"))}},scrollToHandler:function(t){var e=window.pageYOffset||t.scrollTop,t=t.getBoundingClientRect().top+e-90;window.parent.scrollTo({top:t,behavior:"smooth"})}},t.dataset.tourButtonSecondary&&e.buttons.push({text:t.dataset.tourButtonSecondary,secondary:!0}),o.splice(Number(t.dataset.tourStep)-1,1,e))}),o.sort()}return!1},e.prototype.dismissTour=function(){this.tourName&&o.post("/user/_/dismiss-tourguide/"+this.tourName,null)},e.prototype.cleanUpTour=function(){this.tour&&(this.tour.off("cancel"),this.tour.off("complete"),this.tour=!1,this.tourName=!1)},e});