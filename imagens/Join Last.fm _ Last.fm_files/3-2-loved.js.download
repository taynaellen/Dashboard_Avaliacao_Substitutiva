define(["jquery","core/ajax","kerve/helpers/windowscroll","kerve/helpers/windowsize","kerve/helpers/helper","kerve/plugins/jquery.touchSwipe.1.6.min"],function(e,l,o,n,i,a){function t(e,a){this.el=e}t.prototype.start=function(){r.logs=1==i.config.logs||1==r.dev,r.logs&&console.log("%c*** WIDGET - 3.2 TODAY'S MOST LOVED - START ***","color:#098c0c;"),r.el=this.el,r.locale=r.el.attr("data-locale")||"",r.locale_plays=r.el.attr("data-locale-plays")||"",r.locale_play=r.el.attr("data-locale-play")||"",r.wrap=r.el.find(".lovedwrap"),r.label_scroll=r.el.find(".label_scroll"),r.label_span=r.el.find(".label_span"),r.result=r.el.find(".loved_result"),r.scrobbles=r.el.find(".loved_scrobbles"),r.circle=r.el.find("#loved_halo"),r.image=r.el.find(".loved_img"),r.image2=r.el.find(".loved_img2"),r.el.on("mouseenter",".lovedwrap",function(){_()}),r.el.on("mouseleave",".lovedwrap",function(){s()}),r.el.on("click",".lovedleft",function(){return 1==r.got_data&&(m(),g()),!1}),r.el.on("click",".lovedright",function(){return 1==r.got_data&&(m(),p()),!1}),r.el.swipe({swipeRight:function(){m(),g()},swipeLeft:function(){m(),p()},threshold:100,excludedElements:""}),1==r.dev_data||1==i.config.dev?(c=i.dev["3-2-loved"],u()):l.get(r.query_url,null,{type:"track",loved:1,nr:20,format:"json"},function(e,a,t,l){r.logs&&console.log("--- ajax response - 3.2 today's most loved ---"),r.logs&&console.log(a.results.track),void 0!==a.results.track[0]&&(c=a.results.track,u())});var e=r.wrap.offset().top,a=e+r.wrap.height()/2,t=e+r.wrap.height();o.add("loved",a,function(){!function e(){1==r.got_data?r.timeout_init=setTimeout(function(){v(c[0].weight)},1e3):r.timeout_retry=setTimeout(function(){e()},50)}()},e,t,function(){_()},function(){s()}),n.add("loved",{x_func:function(){var e,a,t;0==o.done("loved")&&(a=(e=r.wrap.offset().top)+r.wrap.height()/2,t=e+r.wrap.height(),o.update_pos("loved",a,e,t)),i.label_scroll(r.label_scroll,r.label_span)}})};var r={dev:!(t.prototype.stop=function(){r.logs&&console.log("%c*** WIDGET - 3.2 TODAY'S MOST LOVED - STOP ***","color:#098c0c;"),clearTimeout(r.timeout_retry),clearTimeout(r.timeout_init),clearTimeout(r.timeout_autoplay),clearInterval(r.int_autoplay),c={},o.reset(),n.reset()}),dev_data:!1,query_url:"https://kerve.last.fm/kerve/charts",autoplay_interval:5e3,resume_timeout:3e3,circ_min:22,circ_max:330,circ_range:210,got_data:!1,paused:!0,max_val:0,min_val:0,range:0,current:0,total:0,multi_max:6,multi_min:1,prev_image:null,circ_r:119,dash:null,dash_min:null,dash_max:null,dash_range:null,timeout_retry:null,timeout_init:null,timeout_autoplay:null,int_autoplay:null},c={};function u(){for(var e in r.total=c.length,d(c[0],!0),r.dash_min=2*Math.PI*r.circ_r*(r.circ_min/360),r.dash_max=2*Math.PI*r.circ_r*(r.circ_max/360),r.dash_range=r.dash_max-r.dash_min,c)(0==r.min_val||c[e].weight<r.min_val)&&(r.min_val=c[e].weight),(0==r.max_val||c[e].weight>r.max_val)&&(r.max_val=c[e].weight);r.range=r.max_val-r.min_val,r.got_data=!0,s()}function s(){1==r.paused&&(clearInterval(r.int_autoplay),r.int_autoplay=setInterval(function(){r.paused=!1,p()},r.autoplay_interval))}function m(){clearInterval(r.int_autoplay),clearTimeout(r.timeout_autoplay),r.paused=!0,r.timeout_autoplay=setTimeout(function(){s()},r.resume_timeout)}function _(){r.paused=!0,clearInterval(r.int_autoplay),clearTimeout(r.timeout_autoplay)}function d(e,a){r.result.html(i.track(e.artist,e.artist_url,e.name,e.url,r.locale)+i.play(r.locale_play,e.playlink)),r.scrobbles.html(r.locale_plays+": "+i.commas(e.scrobbles)),i.label_scroll(r.label_scroll,r.label_span),null==r.prev_image?""!=e.image?r.image2.css({"background-image":"url("+e.image+")"}):r.image2.css({"background-image":"none"}):((""!=r.prev_image?r.image.stop(!0,!0).css({"background-image":"url("+r.prev_image+")",opacity:1}):r.image.stop(!0,!0).css({"background-image":"none",opacity:1})).delay(300).animate({opacity:0},500),(""!=e.image?r.image2.stop(!0,!0).css({opacity:0,"background-image":"url("+e.image+")"}):r.image2.stop(!0,!0).css({opacity:0,"background-image":"none"})).animate({opacity:1},500)),r.prev_image=e.image,1!=a&&v(e.weight),void 0!==c[r.current+1]&&""!=c[r.current+1].image&&((new Image).src=c[r.current+1].image),void 0!==c[r.current-1]?""!=c[r.current-1].image&&((new Image).src=c[r.current-1].image):void 0!==c[c.length-1]&&""!=c[c.length-1].image&&((new Image).src=c[c.length-1].image)}function g(){0<r.current?r.current--:r.current=r.total-1,d(c[r.current])}function p(){r.current<r.total-1?r.current++:r.current=0,d(c[r.current])}function v(e){var a,t,l;r.dash=(a=e,t=r.multi_max-r.multi_min,l=r.dash_range,t/=l,l=(e-r.min_val)/r.range*r.dash_range+r.dash_min,a=(l-r.dash_min)*t,t=r.multi_max/(a+r.multi_min),l*t),r.circle.attr("stroke-dasharray",r.dash+",1000")}return t});